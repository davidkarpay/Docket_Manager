<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Docket Manager - File Database</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .file-input-label:hover {
            background-color: #2980b9;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            border: none;
            font-size: 14px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background-color: #d68910;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .search-wrapper {
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .advanced-search-toggle {
            background-color: #9b59b6;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            border: none;
            font-size: 14px;
        }

        .advanced-search-toggle:hover {
            background-color: #8e44ad;
        }

        .advanced-search-panel {
            background-color: #f8f9fa;
            border: 2px solid #9b59b6;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .advanced-search-panel.active {
            display: block;
        }

        .advanced-search-header {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .filter-select {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
            background-color: white;
        }

        .filter-select:focus {
            outline: none;
            border-color: #9b59b6;
        }

        .filter-input {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-input:focus {
            outline: none;
            border-color: #9b59b6;
        }

        .event-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .event-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .event-badge.speedy-trial {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .event-badge.appearance-waiver {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .event-badge.continuance {
            background-color: #fff3e0;
            color: #e65100;
        }

        .event-badge.plea {
            background-color: #f3e5f5;
            color: #6a1b9a;
        }

        .event-badge.bond {
            background-color: #fce4ec;
            color: #c2185b;
        }

        .event-badge.motion {
            background-color: #e0f2f1;
            color: #00695c;
        }

        .event-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .event-badge.active {
            border-color: #2c3e50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            background-color: #ecf0f1;
            padding: 15px 20px;
            border-radius: 4px;
            min-width: 150px;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-top: 5px;
        }

        .database-panel {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }

        .database-panel.active {
            display: block;
        }

        .database-panel.inactive {
            background-color: #fff3cd;
            border-color: #ffc107;
        }

        .database-header {
            font-size: 18px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .database-panel.inactive .database-header {
            color: #856404;
        }

        .database-info {
            color: #2e7d32;
            margin-bottom: 15px;
            line-height: 1.8;
        }

        .database-panel.inactive .database-info {
            color: #856404;
        }

        .database-location {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #2c3e50;
            word-break: break-all;
        }

        .database-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .case-list {
            display: none;
        }

        .case-list.active {
            display: block;
        }

        .case-card {
            background-color: #fff;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            transition: box-shadow 0.3s, border-color 0.3s;
        }

        .case-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #3498db;
        }

        .case-card.hidden {
            display: none;
        }

        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .client-name {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .case-number {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .next-date {
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 14px;
        }

        .case-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 500;
        }

        .notes-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notes-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .empty-state-subtext {
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .modal-body {
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .stats-container {
            display: none;
        }

        .stats-container.active {
            display: block;
        }

        #actionButtons {
            display: none;
        }

        #actionButtons.active {
            display: flex;
        }

        .case-history-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .add-event-btn {
            background-color: #9b59b6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .add-event-btn:hover {
            background-color: #8e44ad;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
            margin-top: 15px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #ddd;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -36px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #3498db;
            border: 2px solid white;
            box-shadow: 0 0 0 2px #3498db;
        }

        .timeline-item.speedy-trial::before {
            background-color: #2e7d32;
            box-shadow: 0 0 0 2px #2e7d32;
        }

        .timeline-item.appearance-waiver::before {
            background-color: #1565c0;
            box-shadow: 0 0 0 2px #1565c0;
        }

        .timeline-item.continuance::before {
            background-color: #e65100;
            box-shadow: 0 0 0 2px #e65100;
        }

        .timeline-item.plea::before {
            background-color: #6a1b9a;
            box-shadow: 0 0 0 2px #6a1b9a;
        }

        .timeline-item.bond::before {
            background-color: #c2185b;
            box-shadow: 0 0 0 2px #c2185b;
        }

        .timeline-item.motion::before {
            background-color: #00695c;
            box-shadow: 0 0 0 2px #00695c;
        }

        .event-type {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            text-transform: capitalize;
        }

        .event-date {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .event-description {
            color: #555;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .event-source {
            font-size: 12px;
            color: #95a5a6;
            font-style: italic;
        }

        .event-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        .event-action-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: opacity 0.3s;
        }

        .event-action-btn:hover {
            opacity: 0.8;
        }

        .event-action-btn.delete {
            background-color: #e74c3c;
            color: white;
        }

        .empty-history {
            text-align: center;
            padding: 30px;
            color: #95a5a6;
            font-style: italic;
        }

        .event-form {
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .form-row {
            margin-bottom: 15px;
        }

        .form-row label {
            display: block;
            font-size: 13px;
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .form-row input,
        .form-row select,
        .form-row textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-row input:focus,
        .form-row select:focus,
        .form-row textarea:focus {
            outline: none;
            border-color: #9b59b6;
        }

        .form-row textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèõÔ∏è Morning Docket Manager</h1>
        <p class="subtitle">File-Based Database Edition - Your data, your location</p>

        <div class="controls">
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" accept=".csv" multiple />
                <label for="csvFile" class="file-input-label">üìÇ Load CSV Docket(s)</label>
            </div>

            <div class="search-wrapper">
                <input type="text" id="searchInput" class="search-input"
                       placeholder="Search by client name, case number, charges, attorney, judge..."
                       disabled />
            </div>

            <button class="advanced-search-toggle" onclick="toggleAdvancedSearch()" id="advancedSearchToggle" style="display: none;">
                üîç Advanced Search
            </button>
        </div>

        <div id="advancedSearchPanel" class="advanced-search-panel">
            <div class="advanced-search-header">üéØ Case History Search</div>
            <div class="search-filters">
                <div class="filter-group">
                    <label class="filter-label">Event Type</label>
                    <select id="eventTypeFilter" class="filter-select">
                        <option value="">All Event Types</option>
                        <option value="speedy-trial">Speedy Trial Waived</option>
                        <option value="appearance-waiver">Appearance Waiver</option>
                        <option value="continuance">Continuance Granted</option>
                        <option value="plea">Plea Entry</option>
                        <option value="bond">Bond Modification</option>
                        <option value="motion">Motion Filed</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">From Date</label>
                    <input type="date" id="fromDateFilter" class="filter-input" />
                </div>
                <div class="filter-group">
                    <label class="filter-label">To Date</label>
                    <input type="date" id="toDateFilter" class="filter-input" />
                </div>
                <div class="filter-group">
                    <label class="filter-label">Event Description</label>
                    <input type="text" id="eventDescFilter" class="filter-input"
                           placeholder="Search event details..." />
                </div>
            </div>
            <div class="event-badges">
                <span class="event-badge speedy-trial" onclick="quickFilterEvent('speedy-trial')">
                    ‚ö° Speedy Trial Waived
                </span>
                <span class="event-badge appearance-waiver" onclick="quickFilterEvent('appearance-waiver')">
                    üë§ Appearance Waiver
                </span>
                <span class="event-badge continuance" onclick="quickFilterEvent('continuance')">
                    ‚è∞ Continuance
                </span>
                <span class="event-badge plea" onclick="quickFilterEvent('plea')">
                    ‚öñÔ∏è Plea Entry
                </span>
                <span class="event-badge bond" onclick="quickFilterEvent('bond')">
                    üí∞ Bond Modification
                </span>
                <span class="event-badge motion" onclick="quickFilterEvent('motion')">
                    üìÑ Motion Filed
                </span>
            </div>
        </div>

        <div id="databasePanel" class="database-panel">
            <div class="database-header">üìÅ Database Configuration</div>
            <div class="database-info">
                <div id="databaseStatus"></div>
                <div id="databaseLocationDisplay" class="database-location" style="display: none;"></div>
            </div>
            <div class="database-actions">
                <button class="btn btn-primary" onclick="selectDatabaseLocation()">Select Database Location</button>
                <button class="btn btn-secondary" onclick="loadFromDatabase()" id="loadDbBtn" style="display: none;">Load from Database</button>
                <button class="btn btn-warning" onclick="changeDatabase()">Change Database File</button>
            </div>
        </div>

        <div id="statsContainer" class="stats-container">
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">Total Cases</div>
                    <div class="stat-value" id="totalCases">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Cases with Notes</div>
                    <div class="stat-value" id="casesWithNotes">0</div>
                </div>
                <div class="stat-box" id="dbCasesBox" style="display: none;">
                    <div class="stat-label">Cases in Database</div>
                    <div class="stat-value" id="dbCases">0</div>
                </div>
            </div>
        </div>

        <div id="actionButtons" class="action-buttons">
            <button class="btn btn-success" onclick="exportNotes()">üìù Export Notes</button>
            <button class="btn btn-warning" onclick="saveToDatabase()" id="saveDbBtn" style="display: none;">üíæ Save to Database</button>
            <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
        </div>

        <div id="emptyState" class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <div class="empty-state-text">No docket loaded</div>
            <div class="empty-state-subtext">Upload one or more CSV files to get started, or load from your database if you have one configured</div>
        </div>

        <div id="caseList" class="case-list"></div>
    </div>

    <div id="modalOverlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-header" id="modalHeader"></div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions" id="modalActions"></div>
        </div>
    </div>

    <script>
        // Global variables
        let casesData = [];
        let notesData = {};
        let caseMetadata = {};
        let caseEvents = {}; // Maps case IDs to their events array
        let databaseFileHandle = null;
        let databaseDirectoryHandle = null;
        let databaseFileName = 'docket_database.json';
        let dbEnabled = false;
        let activeEventFilters = {
            eventType: '',
            fromDate: '',
            toDate: '',
            description: ''
        };

        // Check if File System Access API is supported
        const fileSystemSupported = 'showOpenFilePicker' in window || 'showDirectoryPicker' in window;

        // Event type configurations
        const eventTypes = {
            'speedy-trial': {
                label: 'Speedy Trial Waived',
                icon: '‚ö°',
                color: '#2e7d32'
            },
            'appearance-waiver': {
                label: 'Appearance Waiver',
                icon: 'üë§',
                color: '#1565c0'
            },
            'continuance': {
                label: 'Continuance Granted',
                icon: '‚è∞',
                color: '#e65100'
            },
            'plea': {
                label: 'Plea Entry',
                icon: '‚öñÔ∏è',
                color: '#6a1b9a'
            },
            'bond': {
                label: 'Bond Modification',
                icon: 'üí∞',
                color: '#c2185b'
            },
            'motion': {
                label: 'Motion Filed',
                icon: 'üìÑ',
                color: '#00695c'
            },
            'other': {
                label: 'Other Event',
                icon: 'üìã',
                color: '#3498db'
            }
        };

        // Modal functions
        function showModal(title, body, actions) {
            document.getElementById('modalHeader').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            
            const actionsContainer = document.getElementById('modalActions');
            actionsContainer.innerHTML = '';
            
            actions.forEach(action => {
                const button = document.createElement('button');
                button.className = `btn ${action.class}`;
                button.textContent = action.text;
                button.onclick = action.action;
                actionsContainer.appendChild(button);
            });
            
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        // Check browser compatibility
        function checkCompatibility() {
            if (!fileSystemSupported) {
                showModal('Browser Not Supported', 
                    'Your browser does not support the File System Access API. Please use a recent version of Chrome, Edge, or another Chromium-based browser to use the file-based database feature.',
                    [{ text: 'OK', class: 'btn-secondary', action: () => {
                        closeModal();
                        document.getElementById('databasePanel').style.display = 'none';
                    }}]
                );
                return false;
            }
            return true;
        }

        // Select database location
        async function selectDatabaseLocation() {
            if (!checkCompatibility()) return;

            try {
                // Ask user to select a directory
                databaseDirectoryHandle = await window.showDirectoryPicker({
                    mode: 'readwrite',
                    startIn: 'documents'
                });

                // Try to get existing database file
                try {
                    databaseFileHandle = await databaseDirectoryHandle.getFileHandle(databaseFileName, { create: false });
                    
                    // Database file exists, ask if they want to load it
                    showModal('Existing Database Found', 
                        `A database file already exists at this location. Would you like to load the existing data?`,
                        [
                            { text: 'Load Existing Data', class: 'btn-primary', action: async () => {
                                closeModal();
                                await loadFromDatabase();
                                updateDatabaseStatus();
                            }},
                            { text: 'Create New Database', class: 'btn-warning', action: async () => {
                                closeModal();
                                // Create a new empty database
                                await createNewDatabase();
                            }},
                            { text: 'Cancel', class: 'btn-secondary', action: closeModal }
                        ]
                    );
                } catch (err) {
                    // File doesn't exist, create new one
                    await createNewDatabase();
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Error selecting directory:', err);
                    showModal('Error', 
                        'Failed to select database location: ' + err.message,
                        [{ text: 'OK', class: 'btn-secondary', action: closeModal }]
                    );
                }
            }
        }

        // Create new database file
        async function createNewDatabase() {
            try {
                databaseFileHandle = await databaseDirectoryHandle.getFileHandle(databaseFileName, { create: true });

                // Initialize with v2.0 database schema
                const initialData = {
                    version: '2.0',
                    lastModified: new Date().toISOString(),
                    cases: [],
                    schema: [],
                    events: {},
                    notes: {}
                };

                await saveDatabaseFile(initialData);
                dbEnabled = true;
                updateDatabaseStatus();

                showModal('Database Created',
                    'A new database file has been created with event tracking support. You can now load CSV files and track case history.',
                    [{ text: 'OK', class: 'btn-primary', action: closeModal }]
                );
            } catch (err) {
                console.error('Error creating database:', err);
                showModal('Error',
                    'Failed to create database file: ' + err.message,
                    [{ text: 'btn-secondary', class: 'btn-secondary', action: closeModal }]
                );
            }
        }

        // Save data to database file
        async function saveDatabaseFile(data) {
            if (!databaseFileHandle) {
                throw new Error('No database file selected');
            }

            const writable = await databaseFileHandle.createWritable();
            await writable.write(JSON.stringify(data, null, 2));
            await writable.close();
        }

        // Load data from database file
        async function loadDatabaseFile() {
            if (!databaseFileHandle) {
                throw new Error('No database file selected');
            }

            const file = await databaseFileHandle.getFile();
            const text = await file.text();
            return JSON.parse(text);
        }

        // Save current cases to database
        async function saveToDatabase() {
            if (!dbEnabled || !databaseFileHandle) {
                showModal('No Database Configured',
                    'Please select a database location first.',
                    [{ text: 'Select Location', class: 'btn-primary', action: async () => {
                        closeModal();
                        await selectDatabaseLocation();
                    }},
                    { text: 'Cancel', class: 'btn-secondary', action: closeModal }]
                );
                return;
            }

            try {
                const dbData = {
                    version: '2.0',
                    lastModified: new Date().toISOString(),
                    cases: casesData,
                    schema: casesData.length > 0 ? Object.keys(casesData[0]) : [],
                    events: caseEvents,
                    notes: notesData
                };

                await saveDatabaseFile(dbData);

                showModal('Saved',
                    `Successfully saved ${casesData.length} cases and their event history to the database.`,
                    [{ text: 'OK', class: 'btn-primary', action: closeModal }]
                );

                updateDatabaseStats();
            } catch (err) {
                console.error('Error saving to database:', err);
                showModal('Save Failed',
                    'Failed to save to database: ' + err.message,
                    [{ text: 'OK', class: 'btn-secondary', action: closeModal }]
                );
            }
        }

        // Load cases from database
        async function loadFromDatabase() {
            if (!dbEnabled || !databaseFileHandle) {
                showModal('No Database Configured',
                    'Please select a database location first.',
                    [{ text: 'Select Location', class: 'btn-primary', action: async () => {
                        closeModal();
                        await selectDatabaseLocation();
                    }},
                    { text: 'Cancel', class: 'btn-secondary', action: closeModal }]
                );
                return;
            }

            try {
                let dbData = await loadDatabaseFile();

                // Migrate v1.0 to v2.0 if needed
                if (dbData.version === '1.0') {
                    dbData = await migrateDatabase(dbData);
                }

                if (dbData.cases && dbData.cases.length > 0) {
                    casesData = dbData.cases;
                    caseEvents = dbData.events || {};
                    notesData = dbData.notes || {};

                    displayCases();

                    const eventCount = Object.values(caseEvents).reduce((sum, events) => sum + (events?.length || 0), 0);

                    showModal('Loaded',
                        `Successfully loaded ${casesData.length} cases with ${eventCount} historical events from the database.`,
                        [{ text: 'OK', class: 'btn-primary', action: closeModal }]
                    );
                } else {
                    showModal('Empty Database',
                        'The database exists but contains no cases.',
                        [{ text: 'OK', class: 'btn-secondary', action: closeModal }]
                    );
                }

                updateDatabaseStats();
            } catch (err) {
                console.error('Error loading from database:', err);
                showModal('Load Failed',
                    'Failed to load from database: ' + err.message,
                    [{ text: 'OK', class: 'btn-secondary', action: closeModal }]
                );
            }
        }

        // Migrate database from v1.0 to v2.0
        async function migrateDatabase(oldData) {
            const newData = {
                version: '2.0',
                lastModified: new Date().toISOString(),
                cases: oldData.cases || [],
                schema: oldData.schema || [],
                events: {},
                notes: notesData
            };

            // Save migrated database
            if (databaseFileHandle) {
                await saveDatabaseFile(newData);
                showModal('Database Upgraded',
                    'Your database has been automatically upgraded to v2.0 with event tracking support!',
                    [{ text: 'OK', class: 'btn-success', action: closeModal }]
                );
            }

            return newData;
        }

        // Change database file
        async function changeDatabase() {
            showModal('Change Database', 
                'Do you want to select a different database location? This will disconnect from the current database.',
                [
                    { text: 'Select New Location', class: 'btn-primary', action: async () => {
                        closeModal();
                        databaseFileHandle = null;
                        databaseDirectoryHandle = null;
                        dbEnabled = false;
                        await selectDatabaseLocation();
                    }},
                    { text: 'Cancel', class: 'btn-secondary', action: closeModal }
                ]
            );
        }

        // Update database status display
        function updateDatabaseStatus() {
            const statusDiv = document.getElementById('databaseStatus');
            const locationDiv = document.getElementById('databaseLocationDisplay');
            const panel = document.getElementById('databasePanel');
            const loadBtn = document.getElementById('loadDbBtn');
            const saveBtn = document.getElementById('saveDbBtn');
            
            if (dbEnabled && databaseFileHandle) {
                statusDiv.innerHTML = '‚úÖ <strong>Database Connected</strong><br>Your docket data will be automatically saved to your selected location.';
                panel.classList.add('active');
                panel.classList.remove('inactive');
                locationDiv.style.display = 'block';
                locationDiv.textContent = `Location: ${databaseFileHandle.name}`;
                loadBtn.style.display = 'inline-block';
                saveBtn.style.display = 'inline-block';
            } else {
                statusDiv.innerHTML = '‚ö†Ô∏è <strong>No Database Configured</strong><br>Select a location to save your docket data persistently.';
                panel.classList.remove('active');
                panel.classList.add('inactive');
                locationDiv.style.display = 'none';
                loadBtn.style.display = 'none';
                saveBtn.style.display = 'none';
            }
            
            panel.style.display = 'block';
        }

        // Update database stats
        async function updateDatabaseStats() {
            const dbCasesBox = document.getElementById('dbCasesBox');
            const dbCasesValue = document.getElementById('dbCases');
            
            if (dbEnabled && databaseFileHandle) {
                try {
                    const dbData = await loadDatabaseFile();
                    const count = dbData.cases ? dbData.cases.length : 0;
                    dbCasesValue.textContent = count;
                    dbCasesBox.style.display = 'block';
                } catch (err) {
                    dbCasesBox.style.display = 'none';
                }
            } else {
                dbCasesBox.style.display = 'none';
            }
        }

        // Event Management Functions
        function generateEventId() {
            return 'evt-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function addEvent(caseId, eventType, description, eventDate, source = 'manual') {
            if (!caseEvents[caseId]) {
                caseEvents[caseId] = [];
            }

            const newEvent = {
                id: generateEventId(),
                timestamp: new Date().toISOString(),
                eventDate: eventDate || new Date().toISOString(),
                eventType: eventType,
                description: description,
                source: source
            };

            caseEvents[caseId].push(newEvent);

            // Sort events by date (newest first)
            caseEvents[caseId].sort((a, b) => new Date(b.eventDate) - new Date(a.eventDate));

            // Auto-save if database is enabled
            if (dbEnabled && databaseFileHandle) {
                saveToDatabase().catch(err => console.error('Auto-save failed:', err));
            }

            return newEvent;
        }

        function deleteEvent(caseId, eventId) {
            if (!caseEvents[caseId]) return;

            caseEvents[caseId] = caseEvents[caseId].filter(e => e.id !== eventId);

            // Auto-save if database is enabled
            if (dbEnabled && databaseFileHandle) {
                saveToDatabase().catch(err => console.error('Auto-save failed:', err));
            }
        }

        function getCaseEvents(caseId) {
            return caseEvents[caseId] || [];
        }

        function renderEventTimeline(caseId) {
            const events = getCaseEvents(caseId);

            if (events.length === 0) {
                return '<div class="empty-history">No case history events recorded yet.</div>';
            }

            let html = '<div class="timeline">';
            events.forEach(event => {
                const eventConfig = eventTypes[event.eventType] || eventTypes['other'];
                const eventDate = new Date(event.eventDate).toLocaleDateString();
                const eventTime = new Date(event.eventDate).toLocaleTimeString();

                html += `
                    <div class="timeline-item ${event.eventType}">
                        <div class="event-type">${eventConfig.icon} ${eventConfig.label}</div>
                        <div class="event-date">üìÖ ${eventDate} at ${eventTime}</div>
                        <div class="event-description">${event.description}</div>
                        <div class="event-source">Source: ${event.source}</div>
                        <div class="event-actions">
                            <button class="event-action-btn delete" onclick="confirmDeleteEvent('${caseId}', '${event.id}')">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            return html;
        }

        function confirmDeleteEvent(caseId, eventId) {
            showModal('Delete Event',
                'Are you sure you want to delete this event? This action cannot be undone.',
                [
                    { text: 'Delete', class: 'btn-danger', action: () => {
                        deleteEvent(caseId, eventId);
                        closeModal();
                        displayCases();
                        applyEventFilters();
                    }},
                    { text: 'Cancel', class: 'btn-secondary', action: closeModal }
                ]
            );
        }

        function showAddEventForm(caseId) {
            const formHtml = `
                <div class="event-form">
                    <div class="form-row">
                        <label>Event Type</label>
                        <select id="newEventType">
                            <option value="speedy-trial">‚ö° Speedy Trial Waived</option>
                            <option value="appearance-waiver">üë§ Appearance Waiver</option>
                            <option value="continuance">‚è∞ Continuance Granted</option>
                            <option value="plea">‚öñÔ∏è Plea Entry</option>
                            <option value="bond">üí∞ Bond Modification</option>
                            <option value="motion">üìÑ Motion Filed</option>
                            <option value="other">üìã Other Event</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label>Event Date</label>
                        <input type="date" id="newEventDate" value="${new Date().toISOString().split('T')[0]}" />
                    </div>
                    <div class="form-row">
                        <label>Description</label>
                        <textarea id="newEventDescription" placeholder="Enter event details..."></textarea>
                    </div>
                    <div class="form-row">
                        <label>Source</label>
                        <input type="text" id="newEventSource" value="manual" placeholder="e.g., court record, filing, hearing" />
                    </div>
                </div>
            `;

            showModal('Add Case Event', formHtml, [
                { text: 'Add Event', class: 'btn-success', action: () => {
                    const eventType = document.getElementById('newEventType').value;
                    const eventDate = document.getElementById('newEventDate').value;
                    const description = document.getElementById('newEventDescription').value;
                    const source = document.getElementById('newEventSource').value || 'manual';

                    if (description.trim()) {
                        addEvent(caseId, eventType, description, new Date(eventDate).toISOString(), source);
                        closeModal();
                        displayCases();
                        applyEventFilters();
                    } else {
                        alert('Please enter a description for the event.');
                    }
                }},
                { text: 'Cancel', class: 'btn-secondary', action: closeModal }
            ]);
        }

        // Advanced Search Functions
        function toggleAdvancedSearch() {
            const panel = document.getElementById('advancedSearchPanel');
            panel.classList.toggle('active');
        }

        function quickFilterEvent(eventType) {
            // Toggle the active class on the badge
            const badges = document.querySelectorAll('.event-badge');
            badges.forEach(badge => {
                if (badge.getAttribute('onclick').includes(eventType)) {
                    badge.classList.toggle('active');
                }
            });

            // Set the filter
            const currentFilter = document.getElementById('eventTypeFilter').value;
            if (currentFilter === eventType) {
                document.getElementById('eventTypeFilter').value = '';
                activeEventFilters.eventType = '';
            } else {
                document.getElementById('eventTypeFilter').value = eventType;
                activeEventFilters.eventType = eventType;
            }

            applyEventFilters();
        }

        function applyEventFilters() {
            // Get filter values
            activeEventFilters.eventType = document.getElementById('eventTypeFilter').value;
            activeEventFilters.fromDate = document.getElementById('fromDateFilter').value;
            activeEventFilters.toDate = document.getElementById('toDateFilter').value;
            activeEventFilters.description = document.getElementById('eventDescFilter').value.toLowerCase();

            // Check if any filters are active
            const hasActiveFilters = activeEventFilters.eventType ||
                                    activeEventFilters.fromDate ||
                                    activeEventFilters.toDate ||
                                    activeEventFilters.description;

            if (!hasActiveFilters) {
                // No filters, show all cases
                document.querySelectorAll('.case-card').forEach(card => {
                    card.classList.remove('hidden');
                });
                return;
            }

            // Filter cases based on their events
            document.querySelectorAll('.case-card').forEach(card => {
                const caseId = card.id;
                const events = getCaseEvents(caseId);

                let matchesFilter = false;

                for (const event of events) {
                    // Check event type filter
                    if (activeEventFilters.eventType && event.eventType !== activeEventFilters.eventType) {
                        continue;
                    }

                    // Check date filters
                    const eventDate = new Date(event.eventDate);
                    if (activeEventFilters.fromDate && eventDate < new Date(activeEventFilters.fromDate)) {
                        continue;
                    }
                    if (activeEventFilters.toDate && eventDate > new Date(activeEventFilters.toDate)) {
                        continue;
                    }

                    // Check description filter
                    if (activeEventFilters.description && !event.description.toLowerCase().includes(activeEventFilters.description)) {
                        continue;
                    }

                    // If we get here, this event matches all filters
                    matchesFilter = true;
                    break;
                }

                if (matchesFilter) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        }

        // Parse CSV
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length === 0) return { headers: [], data: [] };

            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = [];
                let currentValue = '';
                let insideQuotes = false;

                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '"') {
                        insideQuotes = !insideQuotes;
                    } else if (char === ',' && !insideQuotes) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim());

                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index].replace(/^"|"$/g, '');
                    });
                    data.push(row);
                }
            }

            return { headers, data };
        }

        // Display cases
        function displayCases() {
            const caseList = document.getElementById('caseList');
            caseList.innerHTML = '';

            if (casesData.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('caseList').classList.remove('active');
                document.getElementById('statsContainer').classList.remove('active');
                document.getElementById('actionButtons').classList.remove('active');
                document.getElementById('searchInput').disabled = true;
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('caseList').classList.add('active');
            document.getElementById('statsContainer').classList.add('active');
            document.getElementById('actionButtons').classList.add('active');
            document.getElementById('searchInput').disabled = false;
            document.getElementById('advancedSearchToggle').style.display = 'inline-block';

            casesData.forEach((caseData, index) => {
                const caseId = `case-${index}`;
                const caseCard = document.createElement('div');
                caseCard.className = 'case-card';
                caseCard.id = caseId;

                const clientName = caseData['Client Name'] || caseData['Defendant'] || 'Unknown Client';
                const caseNumber = caseData['Case Number'] || caseData['Case #'] || 'No Case Number';
                const nextDate = caseData['Next Date'] || caseData['Date'] || 'No Date Set';

                caseMetadata[caseId] = {
                    clientName: clientName,
                    caseNumber: caseNumber,
                    nextDate: nextDate
                };

                let detailsHTML = '';
                Object.keys(caseData).forEach(key => {
                    if (!['Client Name', 'Defendant', 'Case Number', 'Case #', 'Next Date', 'Date'].includes(key)) {
                        detailsHTML += `
                            <div class="detail-item">
                                <div class="detail-label">${key}</div>
                                <div class="detail-value">${caseData[key] || 'N/A'}</div>
                            </div>
                        `;
                    }
                });

                const savedNotes = notesData[caseId] || '';

                caseCard.innerHTML = `
                    <div class="case-header">
                        <div>
                            <div class="client-name">${clientName}</div>
                            <div class="case-number">${caseNumber}</div>
                        </div>
                        <div class="next-date">üìÖ ${nextDate}</div>
                    </div>
                    <div class="case-details">
                        ${detailsHTML}
                    </div>
                    <div class="case-history-section">
                        <div class="history-header">
                            <div class="history-label">üìú Case History</div>
                            <button class="add-event-btn" onclick="showAddEventForm('${caseId}')">
                                + Add Event
                            </button>
                        </div>
                        ${renderEventTimeline(caseId)}
                    </div>
                    <div class="notes-section">
                        <div class="notes-header">
                            <div class="notes-label">Case Notes</div>
                        </div>
                        <textarea class="notes-textarea" placeholder="Add notes for this case..."
                                  data-case-id="${caseId}">${savedNotes}</textarea>
                    </div>
                `;

                caseList.appendChild(caseCard);
            });

            document.querySelectorAll('.notes-textarea').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    const caseId = this.getAttribute('data-case-id');
                    notesData[caseId] = this.value;
                    saveNotes();
                    updateStats();
                });
            });

            updateStats();
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalCases').textContent = casesData.length;
            const notesCount = Object.values(notesData).filter(note => note.trim()).length;
            document.getElementById('casesWithNotes').textContent = notesCount;
        }

        // Perform search
        function performSearch(query) {
            const searchTerm = query.toLowerCase().trim();
            
            document.querySelectorAll('.case-card').forEach(card => {
                if (!searchTerm) {
                    card.classList.remove('hidden');
                    return;
                }

                const cardText = card.textContent.toLowerCase();
                if (cardText.includes(searchTerm)) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        }

        // Save notes to localStorage
        function saveNotes() {
            try {
                localStorage.setItem('docketNotes', JSON.stringify(notesData));
                localStorage.setItem('docketCaseMetadata', JSON.stringify(caseMetadata));
            } catch (e) {
                console.error('Error saving notes to localStorage:', e);
            }
        }

        // Load notes from localStorage
        function loadNotes() {
            try {
                const savedNotes = localStorage.getItem('docketNotes');
                const savedMetadata = localStorage.getItem('docketCaseMetadata');
                
                if (savedNotes) {
                    notesData = JSON.parse(savedNotes);
                }
                if (savedMetadata) {
                    caseMetadata = JSON.parse(savedMetadata);
                }
            } catch (e) {
                console.error('Error loading notes from localStorage:', e);
            }
        }

        // CSV file handler
        document.getElementById('csvFile').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            // If there are existing cases, ask if user wants to append or replace
            if (casesData.length > 0) {
                showModal('Load Multiple Files', 
                    `You have ${casesData.length} cases currently loaded. Do you want to:<br><br>
                    <strong>Append:</strong> Add new cases to existing ones (duplicates will be skipped)<br>
                    <strong>Replace:</strong> Clear existing cases and load only the new files`,
                    [
                        { text: 'Append', class: 'btn-primary', action: async () => {
                            closeModal();
                            await processMultipleCSVFiles(files, true);
                        }},
                        { text: 'Replace', class: 'btn-warning', action: async () => {
                            closeModal();
                            await processMultipleCSVFiles(files, false);
                        }},
                        { text: 'Cancel', class: 'btn-secondary', action: () => {
                            closeModal();
                            e.target.value = ''; // Clear file input
                        }}
                    ]
                );
            } else {
                await processMultipleCSVFiles(files, false);
            }
        });

        // Process multiple CSV files
        async function processMultipleCSVFiles(files, append) {
            let newCases = [];
            let totalProcessed = 0;
            let failedFiles = [];
            let fileDetails = [];

            // If not appending, clear existing cases
            if (!append) {
                casesData = [];
            }

            // Process each file
            for (const file of files) {
                try {
                    const csvData = await readFileAsText(file);
                    const { headers, data } = parseCSV(csvData);

                    if (data.length > 0) {
                        newCases = newCases.concat(data);
                        fileDetails.push({
                            name: file.name,
                            count: data.length,
                            success: true
                        });
                        totalProcessed += data.length;
                    } else {
                        fileDetails.push({
                            name: file.name,
                            count: 0,
                            success: false,
                            error: 'No data found'
                        });
                        failedFiles.push(file.name);
                    }
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    fileDetails.push({
                        name: file.name,
                        count: 0,
                        success: false,
                        error: error.message
                    });
                    failedFiles.push(file.name);
                }
            }

            // Remove duplicates based on case number
            if (append && casesData.length > 0) {
                const existingCaseNumbers = new Set(
                    casesData.map(c => c['Case Number'] || c['Case #'] || '')
                        .filter(num => num)
                );
                
                const beforeCount = newCases.length;
                newCases = newCases.filter(c => {
                    const caseNum = c['Case Number'] || c['Case #'] || '';
                    return caseNum && !existingCaseNumbers.has(caseNum);
                });
                
                const duplicatesRemoved = beforeCount - newCases.length;
                
                casesData = casesData.concat(newCases);
                
                // Show detailed summary
                let summaryHTML = `<strong>Import Summary:</strong><br><br>`;
                summaryHTML += `Files processed: ${files.length}<br>`;
                summaryHTML += `Total cases in files: ${totalProcessed}<br>`;
                summaryHTML += `Duplicates skipped: ${duplicatesRemoved}<br>`;
                summaryHTML += `New cases added: ${newCases.length}<br>`;
                summaryHTML += `Total cases now: ${casesData.length}<br><br>`;
                
                if (fileDetails.length > 0) {
                    summaryHTML += `<strong>File Details:</strong><br>`;
                    summaryHTML += `<div style="max-height: 200px; overflow-y: auto; margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px;">`;
                    fileDetails.forEach(detail => {
                        if (detail.success) {
                            summaryHTML += `‚úÖ ${detail.name}: ${detail.count} cases<br>`;
                        } else {
                            summaryHTML += `‚ùå ${detail.name}: ${detail.error}<br>`;
                        }
                    });
                    summaryHTML += `</div>`;
                }
                
                displayCases();
                
                // Auto-save to database if enabled
                if (dbEnabled && databaseFileHandle && newCases.length > 0) {
                    try {
                        await saveToDatabase();
                        summaryHTML += `<br><br>‚úÖ Cases automatically saved to database.`;
                    } catch (err) {
                        console.error('Auto-save failed:', err);
                        summaryHTML += `<br><br>‚ö†Ô∏è Warning: Auto-save to database failed.`;
                    }
                }
                
                showModal('Files Loaded', summaryHTML, 
                    [{ text: 'OK', class: 'btn-primary', action: closeModal }]
                );
            } else {
                // Not appending or no existing cases
                casesData = newCases;
                
                if (casesData.length > 0) {
                    // Show detailed summary
                    let summaryHTML = `<strong>Import Summary:</strong><br><br>`;
                    summaryHTML += `Files processed: ${files.length}<br>`;
                    summaryHTML += `Total cases loaded: ${casesData.length}<br><br>`;
                    
                    if (fileDetails.length > 0) {
                        summaryHTML += `<strong>File Details:</strong><br>`;
                        summaryHTML += `<div style="max-height: 200px; overflow-y: auto; margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px;">`;
                        fileDetails.forEach(detail => {
                            if (detail.success) {
                                summaryHTML += `‚úÖ ${detail.name}: ${detail.count} cases<br>`;
                            } else {
                                summaryHTML += `‚ùå ${detail.name}: ${detail.error}<br>`;
                            }
                        });
                        summaryHTML += `</div>`;
                    }
                    
                    displayCases();
                    
                    // Auto-save to database if enabled
                    if (dbEnabled && databaseFileHandle) {
                        try {
                            await saveToDatabase();
                            summaryHTML += `<br><br>‚úÖ Cases automatically saved to database.`;
                        } catch (err) {
                            console.error('Auto-save failed:', err);
                            summaryHTML += `<br><br>‚ö†Ô∏è Warning: Auto-save to database failed.`;
                        }
                    }
                    
                    showModal('Files Loaded', summaryHTML, 
                        [{ text: 'OK', class: 'btn-primary', action: closeModal }]
                    );
                } else {
                    showModal('No Data', 
                        'No valid data was found in any of the selected files.',
                        [{ text: 'OK', class: 'btn-secondary', action: closeModal }]
                    );
                }
            }

            // Clear file input
            document.getElementById('csvFile').value = '';
        }

        // Helper function to read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (error) => reject(error);
                reader.readAsText(file);
            });
        }

        // Search input handler
        document.getElementById('searchInput').addEventListener('input', function(e) {
            performSearch(e.target.value);
        });

        // Export notes
        function exportNotes() {
            const notesEntries = Object.entries(notesData)
                .filter(([_, notes]) => notes.trim())
                .map(([caseId, notes]) => {
                    const metadata = caseMetadata[caseId];
                    if (metadata) {
                        return `CLIENT: ${metadata.clientName}
CASE NUMBER: ${metadata.caseNumber}
NEXT DATE: ${metadata.nextDate}

NOTES:
${notes}

${'='.repeat(80)}`;
                    } else {
                        return `CASE ID: ${caseId}

NOTES:
${notes}

${'='.repeat(80)}`;
                    }
                });

            if (notesEntries.length === 0) {
                showModal('No Notes to Export', 
                    'There are currently no notes to export. Add notes to cases first.',
                    [{ text: 'OK', class: 'btn-secondary', action: closeModal }]
                );
                return;
            }

            const header = `MORNING DOCKET NOTES EXPORT
Generated: ${new Date().toLocaleString()}
Total Cases with Notes: ${notesEntries.length}

${'='.repeat(80)}

`;

            const notesText = header + notesEntries.join('\n\n');

            const blob = new Blob([notesText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `docket-notes-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Clear all data
        function clearAllData() {
            showModal('Clear All Data',
                'This will remove all loaded cases, notes, and event history. The database file will not be deleted. This action cannot be undone. Are you sure?',
                [
                    { text: 'Yes, Clear Everything', class: 'btn-danger', action: () => {
                        casesData = [];
                        notesData = {};
                        caseMetadata = {};
                        caseEvents = {};
                        localStorage.removeItem('docketNotes');
                        localStorage.removeItem('docketCaseMetadata');

                        document.getElementById('caseList').innerHTML = '';
                        document.getElementById('caseList').classList.remove('active');
                        document.getElementById('emptyState').style.display = 'block';
                        document.getElementById('statsContainer').classList.remove('active');
                        document.getElementById('actionButtons').classList.remove('active');
                        document.getElementById('searchInput').value = '';
                        document.getElementById('searchInput').disabled = true;
                        document.getElementById('csvFile').value = '';
                        document.getElementById('advancedSearchToggle').style.display = 'none';
                        document.getElementById('advancedSearchPanel').classList.remove('active');

                        updateDatabaseStats();
                        closeModal();
                    }},
                    { text: 'Cancel', class: 'btn-secondary', action: closeModal }
                ]
            );
        }

        // Initialize on load
        async function initialize() {
            loadNotes();
            checkCompatibility();
            updateDatabaseStatus();

            // Add event listeners for advanced search filters
            document.getElementById('eventTypeFilter').addEventListener('change', applyEventFilters);
            document.getElementById('fromDateFilter').addEventListener('change', applyEventFilters);
            document.getElementById('toDateFilter').addEventListener('change', applyEventFilters);
            document.getElementById('eventDescFilter').addEventListener('input', applyEventFilters);
        }

        initialize();
    </script>
</body>
</html>
